---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: homepage
  namespace: homepage
spec:
  chart:
    spec:
      chart: app-template
      version: 2.6.0
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        namespace: flux-system
        name: bjw-s
  interval: 1h
  driftDetection:
    mode: enabled
  values:
    controllers: null
    main: null
    type: statefulset
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      main:
        image:
          main:
            image:
              repository: ghcr.io/gethomepage/homepage
              tag: v0.8.8@sha256:0f066a6d6fba3a810a85aa79a483302b0fee21139b67adaeb245edae5051f3e8
              pullPolicy: IfNotPresent
      code:
        dependsOn: main
        image:
          repository: ghcr.io/codercom/code-server
          tag: 4.20.1
        args:
          - --auth
          - none
          - --user-data-dir
          - /config/.vscode
          - --extensions-dir
          - /config/.vscode
          - --port
          - "8081"
          - /config
service:
  main:
    type: ClusterIP
    ports:
      http:
        port: 3000
  code:
    type: ClusterIP
    controller: main
    ports:
      http:
        port: 8081
  persistence:
    config:
      enabled: true
      existingClaim: homepage-data
      globalMounts:
        - path: /config
ingress:
  main:
    enabled: true
    ingressClassName: external
    annotations: null
    external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN}
    nginx.ingress.kubernetes.io/auth-url: https://authentik-server.security.svc.cluster.local/outpost.goauthentik.io/auth/nginx
    nginx.ingress.kubernetes.io/auth-signin: https://authentik.${SECRET_DOMAIN}/outpost.goauthentik.io/start?rd=$escaped_request_uri
    nginx.ingress.kubernetes.io/auth-response-headers: Set-Cookie,X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header X-Forwarded-Host $http_host;
    hosts:
      - host: homepage.${SECRET_DOMAIN}
        paths:
          - path: /
            pathType: Prefix
    tls:
      - hosts:
          - homepage.${SECRET_DOMAIN}
  code:
    enabled: true
    ingressClassName: external
    annotations: null
    external-dns.alpha.kubernetes.io/target: external.${SECRET_DOMAIN}
    nginx.ingress.kubernetes.io/auth-url: https://authentik-server.security.svc.cluster.local/outpost.goauthentik.io/auth/nginx
    nginx.ingress.kubernetes.io/auth-signin: https://authentik.${SECRET_DOMAIN}/outpost.goauthentik.io/start?rd=$escaped_request_uri
    nginx.ingress.kubernetes.io/auth-response-headers: Set-Cookie,X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header X-Forwarded-Host $http_host;
    hosts:
      - host: homepage-config.${SECRET_DOMAIN}
        paths:
          - path: /
            pathType: Prefix
    tls:
      - hosts:
          - homepage-config.${SECRET_DOMAIN}
